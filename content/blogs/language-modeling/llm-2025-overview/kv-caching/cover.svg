<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: KV_Cache_Phases Pages: 1 -->
<svg width="729pt" height="654pt"
 viewBox="0.00 0.00 729.00 654.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 650)">
<title>KV_Cache_Phases</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-650 725,-650 725,4 -4,4"/>
<text text-anchor="middle" x="360.5" y="-606.6" font-family="Times,serif" font-size="18.00">KV Cache: Prefill vs Generation</text>
<g id="clust1" class="cluster">
<title>cluster_phase1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-155 8,-589 352,-589 352,-155 8,-155"/>
<text text-anchor="middle" x="180" y="-573.8" font-family="Times,serif" font-size="14.00">Phase 1: PREFILL</text>
<text text-anchor="middle" x="180" y="-558.8" font-family="Times,serif" font-size="14.00">Process entire prompt at once</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_phase2</title>
<polygon fill="lightgrey" stroke="lightgrey" points="360,-8 360,-589 713,-589 713,-8 360,-8"/>
<text text-anchor="middle" x="536.5" y="-573.8" font-family="Times,serif" font-size="14.00">Phase 2: GENERATION</text>
<text text-anchor="middle" x="536.5" y="-558.8" font-family="Times,serif" font-size="14.00">Process ONE token at a time</text>
</g>
<!-- p1_prompt -->
<g id="node1" class="node">
<title>p1_prompt</title>
<polygon fill="lightgreen" stroke="black" points="163,-543 29,-543 29,-505 163,-505 163,-543"/>
<text text-anchor="middle" x="96" y="-527.8" font-family="Times,serif" font-size="14.00">Prompt Tokens</text>
<text text-anchor="middle" x="96" y="-512.8" font-family="Times,serif" font-size="14.00">[T₀, T₁, T₂, ..., Tₙ]</text>
</g>
<!-- p1_embed -->
<g id="node2" class="node">
<title>p1_embed</title>
<polygon fill="lightblue" stroke="black" points="171.5,-467 20.5,-467 20.5,-431 171.5,-431 171.5,-467"/>
<text text-anchor="middle" x="96" y="-445.3" font-family="Times,serif" font-size="14.00">Embed ALL tokens</text>
</g>
<!-- p1_prompt&#45;&gt;p1_embed -->
<g id="edge1" class="edge">
<title>p1_prompt&#45;&gt;p1_embed</title>
<path fill="none" stroke="black" d="M96,-504.96C96,-496.7 96,-486.74 96,-477.57"/>
<polygon fill="black" stroke="black" points="99.5,-477.33 96,-467.33 92.5,-477.33 99.5,-477.33"/>
</g>
<!-- p1_qkv -->
<g id="node3" class="node">
<title>p1_qkv</title>
<polygon fill="lightyellow" stroke="black" points="163,-393 29,-393 29,-355 163,-355 163,-393"/>
<text text-anchor="middle" x="96" y="-377.8" font-family="Times,serif" font-size="14.00">Compute Q, K, V</text>
<text text-anchor="middle" x="96" y="-362.8" font-family="Times,serif" font-size="14.00">for ALL tokens</text>
</g>
<!-- p1_embed&#45;&gt;p1_qkv -->
<g id="edge2" class="edge">
<title>p1_embed&#45;&gt;p1_qkv</title>
<path fill="none" stroke="black" d="M96,-430.7C96,-422.49 96,-412.47 96,-403.2"/>
<polygon fill="black" stroke="black" points="99.5,-403.19 96,-393.19 92.5,-403.19 99.5,-403.19"/>
</g>
<!-- p1_attention -->
<g id="node4" class="node">
<title>p1_attention</title>
<polygon fill="lightblue" stroke="black" points="138,-296.5 16,-296.5 16,-258.5 138,-258.5 138,-296.5"/>
<text text-anchor="middle" x="77" y="-281.3" font-family="Times,serif" font-size="14.00">Self&#45;Attention</text>
<text text-anchor="middle" x="77" y="-266.3" font-family="Times,serif" font-size="14.00">(full sequence)</text>
</g>
<!-- p1_qkv&#45;&gt;p1_attention -->
<g id="edge3" class="edge">
<title>p1_qkv&#45;&gt;p1_attention</title>
<path fill="none" stroke="black" d="M92.34,-354.78C89.6,-341.18 85.82,-322.35 82.69,-306.8"/>
<polygon fill="black" stroke="black" points="86.05,-305.78 80.65,-296.66 79.19,-307.16 86.05,-305.78"/>
</g>
<!-- p1_cache -->
<g id="node5" class="node">
<title>p1_cache</title>
<polygon fill="orange" stroke="black" points="344,-296.5 156,-296.5 156,-258.5 344,-258.5 344,-296.5"/>
<text text-anchor="middle" x="250" y="-281.3" font-family="Times,serif" font-size="14.00">KV Cache</text>
<text text-anchor="middle" x="250" y="-266.3" font-family="Times,serif" font-size="14.00">Store K, V for all tokens</text>
</g>
<!-- p1_qkv&#45;&gt;p1_cache -->
<g id="edge4" class="edge">
<title>p1_qkv&#45;&gt;p1_cache</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M125.69,-354.78C150.27,-339.7 185.35,-318.17 211.98,-301.83"/>
<polygon fill="black" stroke="black" points="213.97,-304.72 220.66,-296.5 210.31,-298.75 213.97,-304.72"/>
<text text-anchor="middle" x="193.5" y="-325.8" font-family="Times,serif" font-size="14.00">save</text>
</g>
<!-- p1_output -->
<g id="node6" class="node">
<title>p1_output</title>
<polygon fill="lightcoral" stroke="black" points="192.5,-199 15.5,-199 15.5,-163 192.5,-163 192.5,-199"/>
<text text-anchor="middle" x="104" y="-177.3" font-family="Times,serif" font-size="14.00">First Generated Token</text>
</g>
<!-- p1_attention&#45;&gt;p1_output -->
<g id="edge5" class="edge">
<title>p1_attention&#45;&gt;p1_output</title>
<path fill="none" stroke="black" d="M82.21,-258.28C86.2,-244.29 91.78,-224.75 96.3,-208.96"/>
<polygon fill="black" stroke="black" points="99.7,-209.79 99.08,-199.21 92.97,-207.86 99.7,-209.79"/>
</g>
<!-- p2_new_token -->
<g id="node7" class="node">
<title>p2_new_token</title>
<polygon fill="lightgreen" stroke="black" points="673.5,-543 578.5,-543 578.5,-505 673.5,-505 673.5,-543"/>
<text text-anchor="middle" x="626" y="-527.8" font-family="Times,serif" font-size="14.00">New Token</text>
<text text-anchor="middle" x="626" y="-512.8" font-family="Times,serif" font-size="14.00">[Tₙ₊₁]</text>
</g>
<!-- p2_embed -->
<g id="node8" class="node">
<title>p2_embed</title>
<polygon fill="lightblue" stroke="black" points="682,-468 570,-468 570,-430 682,-430 682,-468"/>
<text text-anchor="middle" x="626" y="-452.8" font-family="Times,serif" font-size="14.00">Embed ONLY</text>
<text text-anchor="middle" x="626" y="-437.8" font-family="Times,serif" font-size="14.00">new token</text>
</g>
<!-- p2_new_token&#45;&gt;p2_embed -->
<g id="edge6" class="edge">
<title>p2_new_token&#45;&gt;p2_embed</title>
<path fill="none" stroke="black" d="M626,-504.96C626,-496.88 626,-487.18 626,-478.18"/>
<polygon fill="black" stroke="black" points="629.5,-478.09 626,-468.09 622.5,-478.09 629.5,-478.09"/>
</g>
<!-- p2_qkv_new -->
<g id="node9" class="node">
<title>p2_qkv_new</title>
<polygon fill="lightyellow" stroke="black" points="704.5,-393 547.5,-393 547.5,-355 704.5,-355 704.5,-393"/>
<text text-anchor="middle" x="626" y="-377.8" font-family="Times,serif" font-size="14.00">Compute Q, K, V</text>
<text text-anchor="middle" x="626" y="-362.8" font-family="Times,serif" font-size="14.00">for NEW token only</text>
</g>
<!-- p2_embed&#45;&gt;p2_qkv_new -->
<g id="edge7" class="edge">
<title>p2_embed&#45;&gt;p2_qkv_new</title>
<path fill="none" stroke="black" d="M626,-429.96C626,-421.88 626,-412.18 626,-403.18"/>
<polygon fill="black" stroke="black" points="629.5,-403.09 626,-393.09 622.5,-403.09 629.5,-403.09"/>
</g>
<!-- p2_concat -->
<g id="node11" class="node">
<title>p2_concat</title>
<polygon fill="lightgray" stroke="black" points="560.5,-304 409.5,-304 409.5,-251 560.5,-251 560.5,-304"/>
<text text-anchor="middle" x="485" y="-288.8" font-family="Times,serif" font-size="14.00">Concatenate</text>
<text text-anchor="middle" x="485" y="-273.8" font-family="Times,serif" font-size="14.00">K_cached + K_new</text>
<text text-anchor="middle" x="485" y="-258.8" font-family="Times,serif" font-size="14.00">V_cached + V_new</text>
</g>
<!-- p2_qkv_new&#45;&gt;p2_concat -->
<g id="edge9" class="edge">
<title>p2_qkv_new&#45;&gt;p2_concat</title>
<path fill="none" stroke="black" d="M552.02,-354.94C540.95,-350.23 530.18,-344.34 521,-337 512.9,-330.52 506.15,-321.69 500.76,-312.85"/>
<polygon fill="black" stroke="black" points="503.79,-311.09 495.83,-304.1 497.69,-314.53 503.79,-311.09"/>
<text text-anchor="middle" x="571" y="-325.8" font-family="Times,serif" font-size="14.00">K_new, V_new</text>
</g>
<!-- p2_attention -->
<g id="node12" class="node">
<title>p2_attention</title>
<polygon fill="lightblue" stroke="black" points="687,-200 565,-200 565,-162 687,-162 687,-200"/>
<text text-anchor="middle" x="626" y="-184.8" font-family="Times,serif" font-size="14.00">Attention</text>
<text text-anchor="middle" x="626" y="-169.8" font-family="Times,serif" font-size="14.00">Q_new @ K_all</text>
</g>
<!-- p2_qkv_new&#45;&gt;p2_attention -->
<g id="edge11" class="edge">
<title>p2_qkv_new&#45;&gt;p2_attention</title>
<path fill="none" stroke="black" d="M626,-354.69C626,-321.24 626,-250.09 626,-210.34"/>
<polygon fill="black" stroke="black" points="629.5,-210.26 626,-200.26 622.5,-210.26 629.5,-210.26"/>
<text text-anchor="middle" x="650" y="-273.8" font-family="Times,serif" font-size="14.00">Q_new</text>
</g>
<!-- p2_cache_retrieve -->
<g id="node10" class="node">
<title>p2_cache_retrieve</title>
<polygon fill="orange" stroke="black" points="529.5,-393 368.5,-393 368.5,-355 529.5,-355 529.5,-393"/>
<text text-anchor="middle" x="449" y="-377.8" font-family="Times,serif" font-size="14.00">KV Cache</text>
<text text-anchor="middle" x="449" y="-362.8" font-family="Times,serif" font-size="14.00">Retrieve stored K, V</text>
</g>
<!-- p2_cache_retrieve&#45;&gt;p2_concat -->
<g id="edge8" class="edge">
<title>p2_cache_retrieve&#45;&gt;p2_concat</title>
<path fill="none" stroke="black" d="M455.94,-354.78C460.39,-343.1 466.31,-327.56 471.65,-313.55"/>
<polygon fill="black" stroke="black" points="474.93,-314.76 475.22,-304.17 468.39,-312.27 474.93,-314.76"/>
</g>
<!-- p2_concat&#45;&gt;p2_attention -->
<g id="edge10" class="edge">
<title>p2_concat&#45;&gt;p2_attention</title>
<path fill="none" stroke="black" d="M506.31,-250.96C516.56,-239.81 529.54,-227.2 543,-218 550.26,-213.04 558.3,-208.53 566.45,-204.51"/>
<polygon fill="black" stroke="black" points="568.1,-207.6 575.66,-200.18 565.12,-201.27 568.1,-207.6"/>
<text text-anchor="middle" x="582" y="-221.8" font-family="Times,serif" font-size="14.00">K_all, V_all</text>
</g>
<!-- p2_cache_update -->
<g id="node13" class="node">
<title>p2_cache_update</title>
<polygon fill="orange" stroke="black" points="546.5,-200 373.5,-200 373.5,-162 546.5,-162 546.5,-200"/>
<text text-anchor="middle" x="460" y="-184.8" font-family="Times,serif" font-size="14.00">KV Cache</text>
<text text-anchor="middle" x="460" y="-169.8" font-family="Times,serif" font-size="14.00">Update with new K, V</text>
</g>
<!-- p2_concat&#45;&gt;p2_cache_update -->
<g id="edge12" class="edge">
<title>p2_concat&#45;&gt;p2_cache_update</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M478.17,-250.68C474.81,-238 470.77,-222.71 467.35,-209.78"/>
<polygon fill="black" stroke="black" points="470.71,-208.78 464.76,-200.01 463.94,-210.57 470.71,-208.78"/>
</g>
<!-- p2_output -->
<g id="node14" class="node">
<title>p2_output</title>
<polygon fill="lightcoral" stroke="black" points="675,-125 577,-125 577,-89 675,-89 675,-125"/>
<text text-anchor="middle" x="626" y="-103.3" font-family="Times,serif" font-size="14.00">Next Token</text>
</g>
<!-- p2_attention&#45;&gt;p2_output -->
<g id="edge13" class="edge">
<title>p2_attention&#45;&gt;p2_output</title>
<path fill="none" stroke="black" d="M626,-161.83C626,-153.89 626,-144.41 626,-135.63"/>
<polygon fill="black" stroke="black" points="629.5,-135.42 626,-125.42 622.5,-135.42 629.5,-135.42"/>
</g>
<!-- p2_loop -->
<g id="node15" class="node">
<title>p2_loop</title>
<ellipse fill="white" stroke="black" cx="626" cy="-34" rx="53.89" ry="18"/>
<text text-anchor="middle" x="626" y="-30.3" font-family="Times,serif" font-size="14.00">Repeat →</text>
</g>
<!-- p2_output&#45;&gt;p2_loop -->
<g id="edge14" class="edge">
<title>p2_output&#45;&gt;p2_loop</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M626,-88.81C626,-80.79 626,-71.05 626,-62.07"/>
<polygon fill="black" stroke="black" points="629.5,-62.03 626,-52.03 622.5,-62.03 629.5,-62.03"/>
</g>
</g>
</svg>
